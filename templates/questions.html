<!DOCTYPE html>
<html>
<head>
	<title>Ask your questions</title>
	{% load static %}
 	<link type="text/css" rel="stylesheet" href="{% static 'home.css' %}" media="screen,projection" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/css/materialize.min.css">
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.3/jquery.mCustomScrollbar.min.css">
	<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans">
	<style type="text/css">
		

	</style>
</head>

<body>

	{% if form.errors %}
    {% for field in form %}
        {% for error in field.errors %}
            <div class="alert alert-danger">
                <strong>{{ error|escape }}</strong>
            </div>
        {% endfor %}
    {% endfor %}
    {% for error in form.non_field_errors %}
        <div class="alert alert-danger">
            <strong>{{ error|escape }}</strong>
        </div>
    {% endfor %}
{% endif %}
	<!-- <div class="menu">
            <div class="back">
            	<a href='{% url "reader"%}'>
            		<i class="fa fa-chevron-left"></i> <img src="https://i.imgur.com/DY6gND0.png" draggable="false"/></a></div>
            <div class="name">Interactive Reader Bot</div>
        </div>
    <ol class="chat">
    <li class="other">
        <div class="avatar"><img src="https://i.imgur.com/DY6gND0.png" draggable="false"/></div>
      <div class="msg">
        <p>Hola!</p>
        <p>Te vienes a cenar al centro? <emoji class="pizza"/></p>
        <time>20:17</time>
      </div>
    </li>
    

    <li class="self">
        <div class="avatar"><img src="https://i.imgur.com/HYcn9xO.png" draggable="false"/></div>
      <div class="msg">
        <p>Es broma</p>
        <p>Ataque Moai!</p>
        <p><span><emoji class="moai"/></span><span><emoji class="moai"/></span><span><emoji class="moai"/></span><span><emoji class="moai"/></span><span><emoji class="moai"/></span><span><emoji class="moai"/></span></p>
        <time>18:09</time>
      </div>
    </li>

    </ol>
    <form method="POST">
    <input class="textarea" type="text" placeholder="Type here!"/></div>
    <div class="" style="margin-top: 23% ; margin-left:80%">
         <input type="submit" name =" ASK QUESTION" class="waves-effect waves-light btn" value="submit">

                    
      </div>
    </form>


</html> -->


<!--

Follow me on
Dribbble: https://dribbble.com/supahfunk
Twitter: https://twitter.com/supahfunk
Codepen: https://codepen.io/supah/

It's just a concept, a fake chat to design a new daily UI for direct messaging.
Hope you like it :)

-->
<div id="iframeContainer" style="width: 900px; height: 600px; overflow: auto;">
	<iframe id = "iframe" src="{% url 'download' book_id %}" id="iframe1" scrolling="no"></iframe>
		</div>
<div class="chat">
  <div class="chat-title">
    <h1>Interactive Reader ChatBot</h1>
    <h2>Supah</h2>
    <figure class="avatar">
      <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/156381/profile/profile-80.jpg" /></figure>
  </div>
  <div class="messages">
    <div class="messages-content">
    	<div class="message new"><figure class="avatar"><img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/156381/profile/profile-80.jpg" /></figure> Hey! there, I am an Interactive reader Bot!! Ask me any questions based on the PDF! :-) 
</div>
    </div>
  </div>
  <div class="message-box">
    <textarea type="text" class="message-input" placeholder="Type message..."></textarea>
    <button type="submit" class="message-submit">Send</button>
  </div>

</div>
<div class="bg"></div>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.3/jquery.mCustomScrollbar.concat.min.js"></script>

 	<script type="text/javascript">
 		

			var $messages = $('.messages-content'),
			    d, h, m,
			    i = 0;

			$(window).load(function() {
			  $messages.mCustomScrollbar();
			  setTimeout(function() {
			    fakeMessage();
			  }, 100);
			});

			function updateScrollbar() {
			  $messages.mCustomScrollbar("update").mCustomScrollbar('scrollTo', 'bottom', {
			    scrollInertia: 10,
			    timeout: 0
			  });
			}

			function setDate(){
			  d = new Date()
			  if (m != d.getMinutes()) {
			    m = d.getMinutes();
			    $('<div class="timestamp">' + d.getHours() + ':' + m + '</div>').appendTo($('.message:last'));
			  }
			}

			function insertMessage() {
			  msg = $('.message-input').val();
			  if ($.trim(msg) == '') {
			    return false;
			  }
			  $('<div class="message message-personal">' + msg + '</div>').appendTo($('.mCSB_container')).addClass('new');
			  setDate();
			  $('.message-input').val(null);
			  updateScrollbar();
			  setTimeout(function() {
			    fakeMessage(msg);
			  }, 1000 + (Math.random() * 20) * 100);
			}

			$('.message-submit').click(function() {
			  insertMessage();
			});

			$(window).on('keydown', function(e) {
			  if (e.which == 13) {
			    insertMessage();
			    return false;
			  }
			})

			var Fake = [
			  'Hi there, I\'m Interactive reader Bot !! Ask me any questions based on the pdf'
			]
			var n = 'Hi there, I\'m Interactive reader Bot !! Ask me any questions based on the pdf';
			var page= 0;
			$('.message.loading').remove();
			    		$('<div class="message new"><figure class="avatar"><img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/156381/profile/profile-80.jpg" /></figure>' + Fake[0] + '</div>').appendTo($('.mCSB_container')).addClass('new');
			function fakeMessage(msg) {
			  if ($('.message-input').val() != '') {
			    return false;
			  }
			  $('<div class="message loading new"><figure class="avatar"><img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/156381/profile/profile-80.jpg" /></figure><span></span></div>').appendTo($('.mCSB_container'));
			  updateScrollbar();

			  setTimeout(function() {
			  		var settings = {
					  "async": true,
					  "crossDomain": true,
					  "url": "http://127.0.0.1:8000/query/",
					  "method": "POST",
					  "headers": {
					    "content-type": "application/json",
					    "cache-control": "no-cache",
					    "postman-token": "edafe4f8-6a25-aec3-ac51-4f30dec4ffad"
					  },
					  "processData": false,
					  "data": "{\"question\": \"" + msg + "\" , \"book_id\":"+ {{book_id}}+" }"
					}

					$.ajax(settings).done(function (response) {
					  console.log(response);
					  var response = response.replace(/'/g, '"');
					  obj = JSON.parse(response);

						console.log(obj.prediction[1]);
						n = obj.prediction[1];
						page_num = obj.page_number;
					   Fake[0] = obj.prediction[1];
					   console.log(Fake[0]);
					   console.log(Fake);
					    $('.message.loading').remove();
			    		$('<div class="message new"><figure class="avatar"><img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/156381/profile/profile-80.jpg" /></figure>' + Fake[0] + '</div>').appendTo($('.mCSB_container')).addClass('new');
			    		$('<div class="message new"><figure class="avatar"><img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/156381/profile/profile-80.jpg" /></figure>' + "Found on page number &nbsp;" + page_num.toString() + '</div>').appendTo($('.mCSB_container')).addClass('new');
					   if (i>1) {
			    	 	page = page_num;
					   console.log(msg);
					   var url = "/download/page/"+{{book_id}}+'/'+page;
					   console.log(url);
					    // $("#someFrame").attr("src",url);
					    var iframe = document.getElementById('iframe');

					    iframe.src = url;	
					    iframe.reload();

					    };

					});
			   

			 /* var question = {"question": msg,
					            "book_id": {{book_id}}
					};
			console.log(question);

			$.ajax({
				url: "{% url 'query' %}",
				data:question,
				type:"post",
				sucess:function(json){
					console.log("success");
					console.log(json);
				}});*/

			

				
			   

			
				
			 //    var xcoord = 200;
			 //    var ycoord = 100;
			 //    var myIframe = document.getElementById('iframe');
				// myIframe.onload = function () {
				//     myIframe.contentWindow.scrollTo(xcoord,ycoord);
				// }
			    setDate();
			    updateScrollbar();
			    i++;
			    // xcoord = xcoord + 20;
			    // ycoord = ycoord + 30;
			  }, 1000 + (Math.random() * 20) * 100);
			}

 	</script>

	 <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/js/materialize.min.js"></script>    

</body>